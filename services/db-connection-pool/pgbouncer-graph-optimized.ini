# PgBouncer Configuration for Graph Visualization Workloads
# Optimized for high-performance graph queries and 20,000+ tracks/hour processing

[databases]
musicdb = host=postgres port=5432 dbname=musicdb user=musicdb_user
musicdb_readonly = host=postgres port=5432 dbname=musicdb user=musicdb_readonly
# Dedicated pool for graph operations
musicdb_graph = host=postgres port=5432 dbname=musicdb user=musicdb_app

[pgbouncer]
# Connection pooling mode - transaction for high throughput
pool_mode = transaction

# Listen configuration
listen_addr = 0.0.0.0
listen_port = 6432

# Authentication
auth_type = md5
auth_file = /etc/pgbouncer/userlist.txt

# Enhanced connection limits for graph workloads
max_client_conn = 2000
default_pool_size = 50
min_pool_size = 10
reserve_pool_size = 20
reserve_pool_timeout = 3

# Server connection limits - increased for graph processing
max_db_connections = 200
max_user_connections = 150

# Optimized connection lifecycle for graph queries
server_lifetime = 7200  # 2 hours for longer graph processing
server_idle_timeout = 300  # 5 minutes
server_connect_timeout = 10
server_login_retry = 10

# Client connection management
client_idle_timeout = 0
client_login_timeout = 30

# Query limits optimized for graph traversal
query_timeout = 300  # 5 minutes for complex graph queries
query_wait_timeout = 60  # 1 minute queue wait

# Admin interface
admin_users = pgbouncer
stats_users = pgbouncer, musicdb_user, musicdb_app

# Performance tuning for graph workloads
server_reset_query = DISCARD ALL
server_check_query = SELECT 1
server_check_delay = 15  # More frequent health checks

# Buffer sizes for large graph result sets
pkt_buf = 8192
listen_backlog = 512
sbuf_loopcnt = 5

# DNS settings
dns_max_ttl = 15
dns_nxdomain_ttl = 15
dns_zone_check_period = 0

# Application name mapping for monitoring
application_name_add_host = 1

# Logging optimized for performance monitoring
log_connections = 1
log_disconnections = 1
log_pooler_errors = 1
verbose = 0
syslog = 0

# Process management
pidfile = /var/run/pgbouncer/pgbouncer.pid
unix_socket_dir = /var/run/pgbouncer

# Memory management for high-throughput
autodb_idle_timeout = 3600
server_fast_close = 1

# TCP settings for network optimization
tcp_defer_accept = 45
tcp_socket_buffer = 0
tcp_keepalive = 1
tcp_keepcnt = 3
tcp_keepidle = 600
tcp_keepintvl = 30

# Security settings
ignore_startup_parameters = extra_float_digits