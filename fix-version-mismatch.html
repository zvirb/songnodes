<!DOCTYPE html>
<html>
<head>
    <title>Fix Zustand Version Mismatch</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1a1a1a;
            color: #00ff00;
        }
        pre {
            background: #000;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
        }
        button {
            background: #00ff00;
            color: #000;
            border: none;
            padding: 10px 20px;
            margin: 10px 5px;
            cursor: pointer;
            font-size: 16px;
            font-family: monospace;
            border-radius: 5px;
        }
        button:hover {
            background: #00cc00;
        }
        .error { color: #ff0000; }
        .success { color: #00ff00; }
        .warning { color: #ffaa00; }
    </style>
</head>
<body>
    <h1>üîß Zustand Version Mismatch Fix</h1>
    <pre id="output">Loading...</pre>

    <div>
        <button onclick="migrateToV6()">üîÑ Migrate to Version 6</button>
        <button onclick="clearAndReload()">üóëÔ∏è Clear All & Reload</button>
        <button onclick="showDiagnostics()">üîç Show Diagnostics</button>
    </div>

    <script>
        const output = document.getElementById('output');

        function log(message, type = 'normal') {
            const colors = {
                error: '#ff0000',
                success: '#00ff00',
                warning: '#ffaa00',
                normal: '#00ff00'
            };
            const line = document.createElement('div');
            line.textContent = message;
            line.style.color = colors[type];
            output.appendChild(line);
        }

        function clearOutput() {
            output.innerHTML = '';
        }

        function showDiagnostics() {
            clearOutput();
            log('=== DIAGNOSTICS ===', 'success');

            const store = localStorage.getItem('songnodes-store');

            if (!store) {
                log('‚ùå No songnodes-store found in localStorage', 'error');
                return;
            }

            log(`‚úì Store exists (${store.length} chars)`, 'success');

            try {
                const parsed = JSON.parse(store);
                log(`\n=== CURRENT DATA ===`, 'success');
                log(`Version: ${parsed.version || 'NONE ‚ö†Ô∏è'}`, parsed.version === 6 ? 'success' : 'warning');
                log(`Has state: ${!!parsed.state}`, parsed.state ? 'success' : 'error');

                if (parsed.state) {
                    log(`State keys: ${Object.keys(parsed.state).join(', ')}`);
                    log(`Has musicCredentials: ${!!parsed.state.musicCredentials}`,
                        parsed.state.musicCredentials ? 'success' : 'warning');

                    if (parsed.state.musicCredentials) {
                        const services = Object.keys(parsed.state.musicCredentials);
                        log(`Music services: ${services.join(', ') || 'none'}`);

                        // Show Tidal credentials if present
                        if (parsed.state.musicCredentials.tidal) {
                            const tidal = parsed.state.musicCredentials.tidal;
                            log(`\n=== TIDAL CREDENTIALS ===`, 'success');
                            log(`Client ID: ${tidal.clientId ? '‚úì Present' : '‚úó Missing'}`,
                                tidal.clientId ? 'success' : 'error');
                            log(`Client Secret: ${tidal.clientSecret ? '‚úì Present' : '‚úó Missing'}`,
                                tidal.clientSecret ? 'success' : 'error');
                            log(`Is Connected: ${tidal.isConnected ? 'Yes' : 'No'}`);
                        }
                    }
                }

                log(`\n=== FULL DATA ===`);
                log(JSON.stringify(parsed, null, 2));

                // Check for version mismatch
                if (parsed.version !== 6) {
                    log(`\n‚ö†Ô∏è  VERSION MISMATCH DETECTED!`, 'error');
                    log(`Current version: ${parsed.version || 'none'}`, 'error');
                    log(`Expected version: 6`, 'success');
                    log(`This is why Zustand rehydration returns null!`, 'error');
                    log(`\nClick "Migrate to Version 6" to fix this.`, 'warning');
                } else {
                    log(`\n‚úì Version is correct (6)`, 'success');
                }

            } catch (e) {
                log(`‚ùå Error parsing JSON: ${e.message}`, 'error');
            }
        }

        function migrateToV6() {
            clearOutput();
            log('=== MIGRATING TO VERSION 6 ===', 'success');

            const store = localStorage.getItem('songnodes-store');

            if (!store) {
                log('‚ùå No data to migrate', 'error');
                return;
            }

            try {
                const parsed = JSON.parse(store);
                const oldVersion = parsed.version || 'none';

                log(`Current version: ${oldVersion}`, 'warning');
                log(`Target version: 6`, 'success');

                // Update version
                parsed.version = 6;

                // Ensure musicCredentials exists in state
                if (parsed.state && !parsed.state.musicCredentials) {
                    log('‚ö†Ô∏è  Adding missing musicCredentials field', 'warning');
                    parsed.state.musicCredentials = {};
                }

                // Save back to localStorage
                localStorage.setItem('songnodes-store', JSON.stringify(parsed));

                log(`\n‚úÖ Migration complete!`, 'success');
                log(`Old version: ${oldVersion} ‚Üí New version: 6`, 'success');
                log(`\nReload the page to test.`, 'warning');

                // Show diagnostics
                setTimeout(showDiagnostics, 500);

            } catch (e) {
                log(`‚ùå Migration failed: ${e.message}`, 'error');
            }
        }

        function clearAndReload() {
            if (confirm('‚ö†Ô∏è  This will DELETE all localStorage data. Continue?')) {
                clearOutput();
                log('Clearing localStorage...', 'warning');
                localStorage.clear();
                log('‚úÖ Cleared!', 'success');
                log('Reloading page in 2 seconds...', 'warning');
                setTimeout(() => window.location.reload(), 2000);
            }
        }

        // Run diagnostics on load
        showDiagnostics();
    </script>
</body>
</html>