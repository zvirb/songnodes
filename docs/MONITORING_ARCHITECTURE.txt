╔══════════════════════════════════════════════════════════════════════════════╗
║                  SONGNODES SCRAPER MONITORING ARCHITECTURE                   ║
╚══════════════════════════════════════════════════════════════════════════════╝

┌─────────────────────────────────────────────────────────────────────────────┐
│                            SCRAPER SERVICES LAYER                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐       │
│  │ 1001TL      │  │ MixesDB     │  │ SetlistFM   │  │ Reddit      │  ...  │
│  │ :8011       │  │ :8012       │  │ :8013       │  │ :8014       │       │
│  ├─────────────┤  ├─────────────┤  ├─────────────┤  ├─────────────┤       │
│  │ /metrics    │  │ /metrics    │  │ /metrics    │  │ /metrics    │       │
│  │ /health     │  │ /health     │  │ /health     │  │ /health     │       │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘       │
│         │                │                 │                 │              │
│         └────────────────┴─────────────────┴─────────────────┘              │
│                                     │                                        │
└─────────────────────────────────────┼────────────────────────────────────────┘
                                      │
                           ┌──────────▼──────────┐
                           │  Metrics Exposed    │
                           │  - Prometheus       │
                           │    Client Library   │
                           └──────────┬──────────┘
                                      │
┌─────────────────────────────────────▼────────────────────────────────────────┐
│                          METRICS COLLECTION LAYER                             │
├───────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                      PROMETHEUS (port 9091)                          │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │                                                                      │    │
│  │  Scrape Configuration (every 30s):                                  │    │
│  │  ┌────────────────────────────────────────────────────────────┐    │    │
│  │  │ - scraper-1001tracklists:8011/metrics                      │    │    │
│  │  │ - scraper-mixesdb:8012/metrics                             │    │    │
│  │  │ - scraper-setlistfm:8013/metrics                           │    │    │
│  │  │ - scraper-reddit:8014/metrics                              │    │    │
│  │  │ - scraper-mixcloud:8015/metrics                            │    │    │
│  │  │ - scraper-soundcloud:8016/metrics                          │    │    │
│  │  │ - scraper-youtube:8017/metrics                             │    │    │
│  │  │ - scraper-internetarchive:8018/metrics                     │    │    │
│  │  │ - scraper-livetracklist:8019/metrics                       │    │    │
│  │  │ - scraper-residentadvisor:8023/metrics                     │    │    │
│  │  └────────────────────────────────────────────────────────────┘    │    │
│  │                                                                      │    │
│  │  Alert Rules:                                                        │    │
│  │  ┌────────────────────────────────────────────────────────────┐    │    │
│  │  │ scraper-data-quality-alerts.yml:                           │    │    │
│  │  │   - ScraperZeroEnhancedTracksCreated (CRITICAL, 6h)        │    │    │
│  │  │   - ScraperHighSchemaErrorRate (CRITICAL, 5min)            │    │    │
│  │  │   - ScraperLowEnhancedTrackRate (WARNING, 2h)              │    │    │
│  │  │   - ScraperArtistCoverageDropped (WARNING, 1h)             │    │    │
│  │  │   - ScraperHighDuplicateRate (WARNING, 30min)              │    │    │
│  │  │                                                             │    │    │
│  │  │ scraper-health-alerts.yml:                                 │    │    │
│  │  │   - ScraperContainerUnhealthy (CRITICAL, 15min)            │    │    │
│  │  │   - ScraperAsyncIOWarningsAccumulating (CRITICAL, 10min)   │    │    │
│  │  │   - ScraperDBConnectionPoolExhausted (CRITICAL, 5min)      │    │    │
│  │  │   - ScraperHighPipelineFlushLatency (WARNING, 10min)       │    │    │
│  │  │   - ScraperHighMemoryUsage (WARNING, 10min)                │    │    │
│  │  └────────────────────────────────────────────────────────────┘    │    │
│  │                                                                      │    │
│  │  Time Series Storage:                                                │    │
│  │  - Retention: 30 days                                                │    │
│  │  - Storage: 10GB limit                                               │    │
│  └──────────────┬─────────────────────────────────┬────────────────────┘    │
│                 │                                  │                         │
└─────────────────┼──────────────────────────────────┼─────────────────────────┘
                  │                                  │
        ┌─────────▼─────────┐          ┌────────────▼────────────┐
        │  ALERTMANAGER     │          │      GRAFANA            │
        │  (port 9093)      │          │      (port 3001)        │
        ├───────────────────┤          ├─────────────────────────┤
        │                   │          │                         │
        │ Alert Routing:    │          │ Dashboards:             │
        │ ┌───────────────┐ │          │ ┌─────────────────────┐ │
        │ │ - Group by    │ │          │ │ scraper-monitoring- │ │
        │ │   scraper     │ │          │ │ comprehensive       │ │
        │ │ - Deduplicate │ │          │ │                     │ │
        │ │ - Route       │ │          │ │ 12 Panels:          │ │
        │ │   severity    │ │          │ │ - Overview Stats    │ │
        │ │ - Throttle    │ │          │ │ - Creation Rates    │ │
        │ │   repeat      │ │          │ │ - Error Tracking    │ │
        │ └───────────────┘ │          │ │ - Health Status     │ │
        │                   │          │ │ - Performance       │ │
        │ Notifications:    │          │ │ - Resources         │ │
        │ ┌───────────────┐ │          │ └─────────────────────┘ │
        │ │ ⚠️  Slack     │ │          │                         │
        │ │ 📧 Email      │ │          │ Variables:              │
        │ │ 🔔 PagerDuty  │ │          │ - Scraper (multi)       │
        │ │ 📱 Webhooks   │ │          │ - Time Range            │
        │ └───────────────┘ │          │                         │
        └───────────────────┘          │ Auto-refresh: 30s       │
                                       └─────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                              METRICS TRACKED                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  DATA VOLUME                      ERROR TRACKING                            │
│  ├─ enhanced_tracks_total         ├─ asyncio_warnings_total                 │
│  ├─ playlists_discovered_total    ├─ schema_errors_total                    │
│  ├─ artists_discovered_total      ├─ validation_errors_total                │
│  └─ artist_coverage_percent       └─ extraction_failures_total              │
│                                                                              │
│  PERFORMANCE                      RESOURCE USAGE                            │
│  ├─ pipeline_flush_duration       ├─ db_connection_pool_usage               │
│  ├─ request_duration              ├─ db_active_connections                  │
│  ├─ items_processing_rate         ├─ redis_connections_active               │
│  └─ run_duration                  └─ memory_usage_bytes                     │
│                                                                              │
│  DATA QUALITY                     CONTAINER HEALTH                          │
│  ├─ duplicate_items_total         ├─ container_health_status                │
│  ├─ enrichment_success/failures   ├─ last_success_timestamp                 │
│  ├─ nlp_extraction_confidence     └─ items_in_queue                         │
│  └─ validation_success_rate                                                 │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                         ALERT SEVERITY LEVELS                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  🔴 CRITICAL (P1) - Immediate action required                               │
│     ├─ ScraperZeroEnhancedTracksCreated (6h)                                │
│     ├─ ScraperHighSchemaErrorRate (5min)                                    │
│     ├─ ScraperContainerUnhealthy (15min)                                    │
│     ├─ ScraperAsyncIOWarningsAccumulating (10min)                           │
│     ├─ ScraperDBConnectionPoolExhausted (5min)                              │
│     └─ ScraperAllExtractionsFailing (15min)                                 │
│                                                                              │
│  🟡 WARNING (P2) - Action needed within hours                               │
│     ├─ ScraperLowEnhancedTrackRate (2h)                                     │
│     ├─ ScraperArtistCoverageDropped (1h)                                    │
│     ├─ ScraperHighPipelineFlushLatency (10min)                              │
│     ├─ ScraperHighMemoryUsage (10min)                                       │
│     ├─ ScraperHighDBConnectionPoolUsage (10min)                             │
│     └─ ScraperHighExtractionFailureRate (10min)                             │
│                                                                              │
│  🔵 INFO (P3-P4) - Track and investigate                                    │
│     ├─ ScraperHighDuplicateRate (30min)                                     │
│     ├─ ScraperLowPlaylistDiscoveryRate (2h)                                 │
│     └─ ScraperLowNLPConfidence (30min)                                      │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                          HEALTHCHECK VALIDATION                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  Enhanced Healthcheck Script: /scrapers/enhanced_healthcheck.py             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                                                                      │   │
│  │  ✅ AsyncIO Warnings Check                                          │   │
│  │     └─ Scans logs for coroutine/event loop warnings                 │   │
│  │                                                                      │   │
│  │  ✅ EnhancedTrackItem Activity Check                                │   │
│  │     └─ Queries DB for tracks created in last 6 hours                │   │
│  │                                                                      │   │
│  │  ✅ Database Connectivity Check                                     │   │
│  │     └─ Tests connection and query performance (<5s)                 │   │
│  │                                                                      │   │
│  │  ✅ Redis Connectivity Check                                        │   │
│  │     └─ Tests Redis PING response                                    │   │
│  │                                                                      │   │
│  │  ✅ Memory Usage Check                                              │   │
│  │     └─ Monitors process memory (warn >800MB, crit >950MB)           │   │
│  │                                                                      │   │
│  │  ✅ Pipeline Health Check                                           │   │
│  │     └─ Checks for stuck pipelines or long processing times          │   │
│  │                                                                      │   │
│  │  ✅ Schema Health Check                                             │   │
│  │     └─ Checks for recent schema validation errors                   │   │
│  │                                                                      │   │
│  │  Exit Codes:                                                         │   │
│  │    0 = Healthy    1 = Warning    2 = Critical    3 = Unknown        │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                            KEY WORKFLOWS                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  1. NORMAL OPERATION                                                         │
│     Scraper → Metrics → Prometheus → Grafana (visualization)                │
│                                                                              │
│  2. ALERT TRIGGERED                                                          │
│     Prometheus (rule violation) → Alertmanager → Notification → On-call     │
│                                                                              │
│  3. HEALTHCHECK FAILURE                                                      │
│     Docker → enhanced_healthcheck.py → Exit Code 2 → Container Unhealthy    │
│                                                                              │
│  4. INCIDENT RESPONSE                                                        │
│     Alert → Runbook → Diagnostic Steps → Resolution → Retrospective         │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘

╔══════════════════════════════════════════════════════════════════════════════╗
║  📊 Dashboard:  http://localhost:3001/d/scraper-monitoring-comprehensive    ║
║  🚨 Alerts:     http://localhost:9093                                        ║
║  📈 Prometheus: http://localhost:9091                                        ║
║  📖 Guide:      /docs/SCRAPER_MONITORING_GUIDE.md                           ║
╚══════════════════════════════════════════════════════════════════════════════╝
