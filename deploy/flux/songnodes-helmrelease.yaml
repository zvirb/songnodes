apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: songnodes
  namespace: flux-system
spec:
  serviceAccountName: helm-controller
  interval: 5m
  timeout: 10m
  targetNamespace: songnodes
  storageNamespace: songnodes
  install:
    createNamespace: true
    remediation:
      retries: 3
  upgrade:
    remediation:
      retries: 3
      strategy: rollback
  chart:
    spec:
      chart: ./deploy/helm/songnodes
      sourceRef:
        kind: GitRepository
        name: songnodes
        namespace: flux-system
      version: 0.1.0
  values:
    namespace:
      create: false
    secrets:
      create: false
    global:
      namespace: songnodes

    # Override POSTGRES_HOST to use FQDN for DNS resolution
    config:
      data:
        POSTGRES_HOST: postgres-0.postgres-service.songnodes.svc.cluster.local

    # Development overrides from values-dev.yaml
    postgres:
      persistence:
        enabled: false
    redis:
      persistence:
        enabled: false
    rabbitmq:
      persistence:
        enabled: false

    services:
      restApi:
        enabled: true
        replicaCount: 1
        image:
          pullPolicy: Always
        resources:
          requests:
            memory: 128Mi
            cpu: 50m
          limits:
            memory: 256Mi
            cpu: 300m
        initContainers: []

      graphVisualization:
        enabled: false

      websocketApi:
        enabled: true
        replicaCount: 1
        image:
          pullPolicy: Always

      nlpProcessor:
        enabled: false

      scraperOrchestrator:
        enabled: false

      metadataEnrichment:
        enabled: true
        replicaCount: 1
        image:
          pullPolicy: Always
        resources:
          requests:
            memory: 256Mi
            cpu: 100m
          limits:
            memory: 512Mi
            cpu: 400m
        initContainers: []

      seratoIntegration:
        enabled: false
        persistence:
          enabled: false

      frontend:
        enabled: true
        replicaCount: 1
        image:
          pullPolicy: Always
        resources:
          requests:
            memory: 64Mi
            cpu: 30m
          limits:
            memory: 128Mi
            cpu: 150m

    autoscaling:
      enabled: false

    ingress:
      enabled: false
