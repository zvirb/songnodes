apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: songnodes
  namespace: flux-system
spec:
  serviceAccountName: helm-controller
  interval: 5m
  timeout: 20m
  targetNamespace: songnodes
  storageNamespace: songnodes
  install:
    createNamespace: true
    remediation:
      retries: 3
  upgrade:
    remediation:
      retries: 3
      strategy: rollback
  chart:
    spec:
      chart: ./deploy/helm/songnodes
      sourceRef:
        kind: GitRepository
        name: songnodes
        namespace: flux-system
      version: 0.1.12
  values:
    namespace:
      create: false
    secrets:
      create: false
    global:
      namespace: songnodes
      # Use local registry for k3s cluster
      imageRegistry: localhost:5000

    # Override POSTGRES_HOST to use StatefulSet pod hostname for DNS resolution
    config:
      data:
        POSTGRES_HOST: postgres-0.postgres-service.songnodes.svc.cluster.local

    # Production configuration with persistence enabled (data migrated from Docker)
    postgres:
      enabled: true
      persistence:
        enabled: true
        size: 20Gi
        storageClass: local-path
      resources:
        requests:
          memory: 1Gi
          cpu: 500m
        limits:
          memory: 2Gi
          cpu: 2000m
    redis:
      persistence:
        enabled: true
        size: 5Gi
        storageClass: local-path
      resources:
        requests:
          memory: 256Mi
          cpu: 100m
        limits:
          memory: 512Mi
          cpu: 500m
    rabbitmq:
      persistence:
        enabled: true
        size: 10Gi
        storageClass: local-path
      resources:
        requests:
          memory: 512Mi
          cpu: 200m
        limits:
          memory: 1Gi
          cpu: 1000m

    services:
      restApi:
        enabled: true
        replicaCount: 1
        image:
          repository: localhost:5000/songnodes_rest-api
          tag: latest
          pullPolicy: Always
        service:
          type: NodePort
          ports:
            http:
              port: 8082
              targetPort: 8082
              nodePort: 30082
        resources:
          requests:
            memory: 256Mi
            cpu: 100m
          limits:
            memory: 512Mi
            cpu: 500m

      graphVisualization:
        enabled: true
        replicaCount: 1
        image:
          repository: localhost:5000/songnodes_graph-visualization-api
          tag: latest
          pullPolicy: Always
        service:
          type: NodePort
          ports:
            http:
              port: 8084
              targetPort: 8084
              nodePort: 30084
        resources:
          requests:
            memory: 128Mi
            cpu: 100m
          limits:
            memory: 256Mi
            cpu: 500m

      websocketApi:
        enabled: true
        replicaCount: 1
        image:
          repository: localhost:5000/songnodes_websocket-api
          tag: latest
          pullPolicy: Always
        service:
          type: NodePort
          ports:
            http:
              port: 8083
              targetPort: 8083
              nodePort: 30083
        resources:
          requests:
            memory: 256Mi
            cpu: 100m
          limits:
            memory: 512Mi
            cpu: 500m

      nlpProcessor:
        enabled: true
        replicaCount: 1
        resources:
          requests:
            memory: 256Mi
            cpu: 100m
          limits:
            memory: 512Mi
            cpu: 500m

      scraperOrchestrator:
        enabled: true
        containerPorts:
          http: 8001
        service:
          ports:
            http:
              port: 8001
              targetPort: 8001
        resources:
          requests:
            memory: 128Mi
            cpu: 100m
          limits:
            memory: 512Mi
            cpu: 500m
        probes:
          liveness:
            enabled: true
            httpGet:
              path: /health
              port: http
            initialDelaySeconds: 60
            periodSeconds: 15
            timeoutSeconds: 15
            failureThreshold: 5
          readiness:
            enabled: true
            httpGet:
              path: /health
              port: http
            initialDelaySeconds: 15
            periodSeconds: 10
            timeoutSeconds: 10
            failureThreshold: 3

      # Individual scraper services - right-sized based on actual usage (36Mi observed)
      scraper1001tracklists:
        enabled: true
        resources:
          requests:
            memory: 128Mi
            cpu: 100m
          limits:
            memory: 512Mi
            cpu: 500m
      scraperMixesdb:
        enabled: true
        resources:
          requests:
            memory: 128Mi
            cpu: 100m
          limits:
            memory: 512Mi
            cpu: 500m
      scraperSetlistfm:
        enabled: true
        resources:
          requests:
            memory: 128Mi
            cpu: 100m
          limits:
            memory: 512Mi
            cpu: 500m
      scraperReddit:
        enabled: true
        resources:
          requests:
            memory: 128Mi
            cpu: 100m
          limits:
            memory: 512Mi
            cpu: 500m
      scraperMixcloud:
        enabled: true
        resources:
          requests:
            memory: 128Mi
            cpu: 100m
          limits:
            memory: 512Mi
            cpu: 500m
      scraperSoundcloud:
        enabled: true
        resources:
          requests:
            memory: 128Mi
            cpu: 100m
          limits:
            memory: 512Mi
            cpu: 500m
      scraperYoutube:
        enabled: true
        resources:
          requests:
            memory: 128Mi
            cpu: 100m
          limits:
            memory: 512Mi
            cpu: 500m
      scraperInternetarchive:
        enabled: true
        resources:
          requests:
            memory: 128Mi
            cpu: 100m
          limits:
            memory: 512Mi
            cpu: 500m
      scraperLivetracklist:
        enabled: true
        resources:
          requests:
            memory: 128Mi
            cpu: 100m
          limits:
            memory: 512Mi
            cpu: 500m
      scraperResidentadvisor:
        enabled: true
        resources:
          requests:
            memory: 128Mi
            cpu: 100m
          limits:
            memory: 512Mi
            cpu: 500m
      scraperBbcSounds:
        enabled: true
        resources:
          requests:
            memory: 128Mi
            cpu: 100m
          limits:
            memory: 512Mi
            cpu: 500m

      metadataEnrichment:
        enabled: true
        replicaCount: 1
        image:
          repository: localhost:5000/songnodes_metadata-enrichment
          tag: latest
          pullPolicy: Always
        resources:
          requests:
            memory: 128Mi
            cpu: 100m
          limits:
            memory: 256Mi
            cpu: 400m
        probes:
          liveness:
            enabled: true
            httpGet:
              path: /health
              port: http
            initialDelaySeconds: 60
            periodSeconds: 15
            timeoutSeconds: 15
            failureThreshold: 5
          readiness:
            enabled: true
            httpGet:
              path: /health
              port: http
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 10
            failureThreshold: 5
          startup:
            enabled: true
            httpGet:
              path: /health
              port: http
            initialDelaySeconds: 0
            periodSeconds: 10
            timeoutSeconds: 10
            failureThreshold: 60

      seratoIntegration:
        enabled: false
        persistence:
          enabled: false

      frontend:
        enabled: true
        replicaCount: 1
        image:
          repository: localhost:5000/songnodes_frontend
          tag: latest
          pullPolicy: Always
        service:
          type: NodePort
          ports:
            http:
              port: 80
              targetPort: 80
              nodePort: 30006
        env:
          static:
            VITE_REST_API_URL: http://192.168.1.55:30082
            VITE_GRAPH_API_URL: http://192.168.1.55:30084
            VITE_WEBSOCKET_URL: ws://192.168.1.55:30083
        resources:
          requests:
            memory: 128Mi
            cpu: 50m
          limits:
            memory: 256Mi
            cpu: 200m

    autoscaling:
      enabled: false

    ingress:
      enabled: false

    networkPolicy:
      enabled: true
