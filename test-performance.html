<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Performance Test - SongNodes</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 40px auto;
            padding: 20px;
            background: #0F172A;
            color: #E2E8F0;
        }
        h1 { color: #60A5FA; }
        .metric {
            background: #1E293B;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #60A5FA;
        }
        .metric strong { color: #10B981; }
        .status {
            padding: 5px 10px;
            border-radius: 4px;
            display: inline-block;
            margin-left: 10px;
        }
        .status.good { background: #10B981; color: white; }
        .status.warning { background: #F59E0B; color: white; }
        .status.error { background: #EF4444; color: white; }
        button {
            background: #3B82F6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover { background: #2563EB; }
        #results {
            margin-top: 20px;
        }
        pre {
            background: #1E293B;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>üöÄ SongNodes Performance Test</h1>

    <div class="metric">
        <strong>Frontend URL:</strong> http://localhost:3006
        <span id="frontend-status" class="status">Checking...</span>
    </div>

    <div class="metric">
        <strong>API Gateway:</strong> http://localhost:8080
        <span id="api-status" class="status">Checking...</span>
    </div>

    <div class="metric">
        <strong>Graph Visualization API:</strong> http://localhost:8005
        <span id="graph-status" class="status">Checking...</span>
    </div>

    <div style="margin: 20px 0;">
        <button onclick="testPerformance()">Test Performance</button>
        <button onclick="loadGraphData()">Load Graph Data</button>
        <button onclick="measureMemory()">Measure Memory</button>
    </div>

    <div id="results"></div>

    <script>
        const resultsDiv = document.getElementById('results');

        // Check service status
        async function checkStatus() {
            // Check frontend
            try {
                const frontendResp = await fetch('http://localhost:3006', { mode: 'no-cors' });
                document.getElementById('frontend-status').className = 'status good';
                document.getElementById('frontend-status').textContent = 'Running';
            } catch (e) {
                document.getElementById('frontend-status').className = 'status error';
                document.getElementById('frontend-status').textContent = 'Not accessible';
            }

            // Check API Gateway
            try {
                const apiResp = await fetch('http://localhost:8080/health');
                document.getElementById('api-status').className = 'status good';
                document.getElementById('api-status').textContent = 'Healthy';
            } catch (e) {
                document.getElementById('api-status').className = 'status warning';
                document.getElementById('api-status').textContent = 'Not responding';
            }

            // Check Graph API
            try {
                const graphResp = await fetch('http://localhost:8005/health');
                document.getElementById('graph-status').className = 'status good';
                document.getElementById('graph-status').textContent = 'Healthy';
            } catch (e) {
                document.getElementById('graph-status').className = 'status warning';
                document.getElementById('graph-status').textContent = 'Not responding';
            }
        }

        // Test performance
        async function testPerformance() {
            resultsDiv.innerHTML = '<div class="metric">Testing performance...</div>';

            const metrics = {
                startTime: performance.now(),
                memoryBefore: performance.memory ? performance.memory.usedJSHeapSize : 0
            };

            try {
                // Load nodes
                const nodesResp = await fetch('http://localhost:8080/api/graph/nodes?limit=100');
                const nodesData = await nodesResp.json();

                // Load edges
                const edgesResp = await fetch('http://localhost:8080/api/graph/edges?limit=500');
                const edgesData = await edgesResp.json();

                metrics.endTime = performance.now();
                metrics.loadTime = metrics.endTime - metrics.startTime;
                metrics.nodeCount = nodesData.nodes?.length || 0;
                metrics.edgeCount = edgesData.edges?.length || 0;
                metrics.memoryAfter = performance.memory ? performance.memory.usedJSHeapSize : 0;
                metrics.memoryUsed = (metrics.memoryAfter - metrics.memoryBefore) / 1048576;

                resultsDiv.innerHTML = `
                    <div class="metric">
                        <h3>‚úÖ Performance Test Results</h3>
                        <p><strong>Load Time:</strong> ${metrics.loadTime.toFixed(2)}ms</p>
                        <p><strong>Nodes Loaded:</strong> ${metrics.nodeCount}</p>
                        <p><strong>Edges Loaded:</strong> ${metrics.edgeCount}</p>
                        <p><strong>Memory Used:</strong> ${metrics.memoryUsed.toFixed(2)}MB</p>
                        <p><strong>Performance Score:</strong> ${
                            metrics.loadTime < 500 ? 'üü¢ Excellent' :
                            metrics.loadTime < 1000 ? 'üü° Good' :
                            'üî¥ Needs Optimization'
                        }</p>
                    </div>
                `;
            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="metric">
                        <h3>‚ùå Error</h3>
                        <pre>${error.message}</pre>
                    </div>
                `;
            }
        }

        // Load graph data
        async function loadGraphData() {
            resultsDiv.innerHTML = '<div class="metric">Loading graph data...</div>';

            try {
                const resp = await fetch('http://localhost:8080/api/graph/nodes?limit=10');
                const data = await resp.json();

                resultsDiv.innerHTML = `
                    <div class="metric">
                        <h3>üìä Graph Data Sample</h3>
                        <p><strong>Total Nodes:</strong> ${data.total || data.nodes?.length || 0}</p>
                        <pre>${JSON.stringify(data.nodes?.slice(0, 3), null, 2)}</pre>
                    </div>
                `;
            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="metric">
                        <h3>‚ùå Error Loading Data</h3>
                        <pre>${error.message}</pre>
                    </div>
                `;
            }
        }

        // Measure memory
        function measureMemory() {
            if (!performance.memory) {
                resultsDiv.innerHTML = `
                    <div class="metric">
                        <h3>‚ö†Ô∏è Memory API Not Available</h3>
                        <p>Enable with: chrome://flags/#enable-precise-memory-info</p>
                    </div>
                `;
                return;
            }

            const memory = performance.memory;
            const used = memory.usedJSHeapSize / 1048576;
            const limit = memory.jsHeapSizeLimit / 1048576;
            const percentage = (used / limit) * 100;

            resultsDiv.innerHTML = `
                <div class="metric">
                    <h3>üíæ Memory Usage</h3>
                    <p><strong>Used:</strong> ${used.toFixed(2)}MB</p>
                    <p><strong>Limit:</strong> ${limit.toFixed(2)}MB</p>
                    <p><strong>Usage:</strong> ${percentage.toFixed(1)}%</p>
                    <p><strong>Status:</strong> ${
                        percentage < 50 ? 'üü¢ Healthy' :
                        percentage < 80 ? 'üü° Moderate' :
                        'üî¥ High'
                    }</p>
                </div>
            `;
        }

        // Initial check
        checkStatus();
    </script>
</body>
</html>