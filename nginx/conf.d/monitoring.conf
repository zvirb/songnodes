# Monitoring and Health Check Configuration
# Optimized for security and performance monitoring

# Health check endpoint
server {
    listen 80;
    server_name health.musicdb.local;
    
    # Simple health check
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
        add_header Cache-Control "no-cache, no-store, must-revalidate";
        add_header Pragma "no-cache";
        add_header Expires "0";
    }
    
    # Nginx status (restricted access)
    location /nginx_status {
        stub_status on;
        access_log off;
        allow 127.0.0.1;
        allow 10.0.0.0/8;
        allow 172.16.0.0/12;
        allow 192.168.0.0/16;
        deny all;
    }
    
    # Block all other requests
    location / {
        return 444;
    }
}

# Metrics collection endpoint (for Prometheus)
server {
    listen 9113;
    server_name metrics.musicdb.local;
    
    # Restrict access to metrics
    allow 127.0.0.1;
    allow 10.0.0.0/8;
    allow 172.16.0.0/12;
    allow 192.168.0.0/16;
    deny all;
    
    location /metrics {
        access_log off;
        # Placeholder for nginx-prometheus-exporter
        return 200 "# HELP nginx_up Whether the nginx server is up\n# TYPE nginx_up gauge\nnginx_up 1\n";
        add_header Content-Type text/plain;
    }
    
    location / {
        return 404;
    }
}

# Log format for security monitoring
log_format security_detailed '$remote_addr - $remote_user [$time_local] '
                            '"$request" $status $body_bytes_sent '
                            '"$http_referer" "$http_user_agent" '
                            '"$http_x_forwarded_for" "$http_x_real_ip" '
                            '$request_time $upstream_response_time '
                            '$blocked_agent $blocked_uri $blocked_country '
                            '$ssl_protocol $ssl_cipher';

# Rate limiting status logging
log_format rate_limit '$remote_addr - [$time_local] "$request" '
                     '$status "$http_user_agent" '
                     'rate_limited=$request_uri';

# SSL/TLS specific logging
log_format ssl_log '$remote_addr - [$time_local] "$request" '
                   '$status $body_bytes_sent '
                   '$ssl_protocol $ssl_cipher $ssl_session_reused '
                   '$ssl_handshake_time';

# Error log configuration with different levels
error_log /var/log/nginx/error.log warn;
error_log /var/log/nginx/security_error.log notice;