# Additional Security Configuration for Nginx
# Advanced security headers and protection mechanisms

# Security Headers Map
map $sent_http_content_type $csp_header {
    default "default-src 'none'; frame-ancestors 'none';";
    ~^text/html "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; connect-src 'self'; font-src 'self'; object-src 'none'; media-src 'self'; frame-src 'none'; frame-ancestors 'none'; base-uri 'self'; form-action 'self';";
    ~^application/json "default-src 'none'; frame-ancestors 'none';";
}

# Add CSP header based on content type
add_header Content-Security-Policy $csp_header always;

# Additional security headers
add_header X-Download-Options noopen always;
add_header X-Permitted-Cross-Domain-Policies none always;
add_header Expect-CT "max-age=86400, enforce" always;

# Feature Policy / Permissions Policy
add_header Permissions-Policy "accelerometer=(), ambient-light-sensor=(), autoplay=(), battery=(), camera=(), cross-origin-isolated=(), display-capture=(), document-domain=(), encrypted-media=(), execution-while-not-rendered=(), execution-while-out-of-viewport=(), fullscreen=(), geolocation=(), gyroscope=(), keyboard-map=(), magnetometer=(), microphone=(), midi=(), navigation-override=(), payment=(), picture-in-picture=(), publickey-credentials-get=(), screen-wake-lock=(), sync-xhr=(), usb=(), web-share=(), xr-spatial-tracking=()" always;

# Block suspicious user agents
map $http_user_agent $blocked_agent {
    default 0;
    ~*sqlmap 1;
    ~*nikto 1;
    ~*nmap 1;
    ~*masscan 1;
    ~*zmap 1;
    ~*metasploit 1;
    ~*burpsuite 1;
    ~*havij 1;
    ~*w3af 1;
    ~*acunetix 1;
    ~*netsparker 1;
    ~*dirbuster 1;
    ~*gobuster 1;
    ~*python-requests 1;
    ~*curl/7\.[0-4] 1;
    ~*libwww-perl 1;
    ~*wget 1;
    "~Mozilla/4.0 \(compatible; MSIE [1-6]\." 1;
}

# Block requests with suspicious patterns
map $request_uri $blocked_uri {
    default 0;
    ~*\.\./\.\. 1;
    ~*\.(env|git|svn|htaccess|htpasswd)$ 1;
    ~*\.(sql|bak|backup|log|conf)$ 1;
    ~*/\.well-known/security\.txt$ 0;
    ~*/phpinfo 1;
    ~*/phpmyadmin 1;
    ~*/wp-admin 1;
    ~*/wp-login 1;
    ~*/admin 1;
    ~*/administrator 1;
    ~*/xmlrpc\.php 1;
    ~*/wp-config 1;
    ~*/config\.php 1;
    ~*/eval\( 1;
    ~*/base64_decode 1;
    ~*/union.*select 1;
    ~*/script.*alert 1;
    ~*<script 1;
    ~*/etc/passwd 1;
    ~*/proc/self 1;
}

# Rate limiting for different types of requests
limit_req_zone $binary_remote_addr zone=auth_strict:10m rate=1r/m;
limit_req_zone $binary_remote_addr zone=password_reset:10m rate=1r/5m;
limit_req_zone $binary_remote_addr zone=file_upload:10m rate=5r/m;

# Connection limits
limit_conn_zone $binary_remote_addr zone=addr:10m;

# Geo-blocking (if needed)
# geo $blocked_country {
#     default 0;
#     # Example: Block specific countries
#     # CN 1;  # China
#     # RU 1;  # Russia
#     # KP 1;  # North Korea
# }

# SSL/TLS Security Configuration
ssl_early_data off;
ssl_ecdh_curve secp384r1;

# OCSP Stapling with security
ssl_stapling_verify on;
ssl_trusted_certificate /etc/nginx/ssl/ca.crt;

# Security-focused SSL session configuration
ssl_session_cache shared:SSL:50m;
ssl_session_timeout 1d;
ssl_session_tickets off;

# Modern SSL configuration for maximum security
ssl_conf_command Ciphersuites TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:TLS_AES_128_GCM_SHA256;
ssl_conf_command Options PrioritizeChaCha;

# Log security events
access_log /var/log/nginx/security.log security if=$blocked_agent;
access_log /var/log/nginx/security.log security if=$blocked_uri;