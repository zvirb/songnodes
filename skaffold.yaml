apiVersion: skaffold/v4beta7
kind: Config
metadata:
  name: songnodes
build:
  local:
    push: true
    useBuildkit: true
  tagPolicy:
    gitCommit:
      variant: AbbrevCommitSha
  artifacts:
    - image: localhost:5000/songnodes_rest-api
      context: services
      docker:
        dockerfile: rest_api/Dockerfile
        buildArgs:
          BUILDKIT_INLINE_CACHE: "1"
    - image: localhost:5000/songnodes_graph-visualization-api
      context: .
      docker:
        dockerfile: services/graph-visualization-api/Dockerfile
        buildArgs:
          BUILDKIT_INLINE_CACHE: "1"
    - image: localhost:5000/songnodes_websocket-api
      context: services
      docker:
        dockerfile: websocket-api/Dockerfile
        buildArgs:
          BUILDKIT_INLINE_CACHE: "1"
    - image: localhost:5000/songnodes_nlp-processor
      context: services/nlp-processor
      docker:
        dockerfile: Dockerfile
        buildArgs:
          BUILDKIT_INLINE_CACHE: "1"
    - image: localhost:5000/songnodes_scraper-orchestrator
      context: services/scraper-orchestrator
      docker:
        dockerfile: Dockerfile
        buildArgs:
          BUILDKIT_INLINE_CACHE: "1"
    - image: localhost:5000/songnodes_metadata-enrichment
      context: .
      docker:
        dockerfile: services/metadata-enrichment/Dockerfile
        buildArgs:
          BUILDKIT_INLINE_CACHE: "1"
    - image: localhost:5000/songnodes_serato-integration
      context: services/serato-integration
      docker:
        dockerfile: Dockerfile
        buildArgs:
          BUILDKIT_INLINE_CACHE: "1"
    - image: localhost:5000/songnodes_frontend
      context: frontend
      docker:
        dockerfile: Dockerfile
        buildArgs:
          BUILDKIT_INLINE_CACHE: "1"
deploy:
  helm:
    releases:
      - name: songnodes
        namespace: songnodes
        createNamespace: true
        chartPath: deploy/helm/songnodes
        valuesFiles:
          - deploy/helm/songnodes/values-dev.yaml
        setValueTemplates:
          services.restApi.image.repository: "{{.IMAGE_NAME_songnodes_rest_api}}"
          services.restApi.image.tag: "{{.IMAGE_TAG_songnodes_rest_api}}"
          services.graphVisualization.image.repository: "{{.IMAGE_NAME_songnodes_graph_visualization_api}}"
          services.graphVisualization.image.tag: "{{.IMAGE_TAG_songnodes_graph_visualization_api}}"
          services.websocketApi.image.repository: "{{.IMAGE_NAME_songnodes_websocket_api}}"
          services.websocketApi.image.tag: "{{.IMAGE_TAG_songnodes_websocket_api}}"
          services.nlpProcessor.image.repository: "{{.IMAGE_NAME_songnodes_nlp_processor}}"
          services.nlpProcessor.image.tag: "{{.IMAGE_TAG_songnodes_nlp_processor}}"
          services.scraperOrchestrator.image.repository: "{{.IMAGE_NAME_songnodes_scraper_orchestrator}}"
          services.scraperOrchestrator.image.tag: "{{.IMAGE_TAG_songnodes_scraper_orchestrator}}"
          services.metadataEnrichment.image.repository: "{{.IMAGE_NAME_songnodes_metadata_enrichment}}"
          services.metadataEnrichment.image.tag: "{{.IMAGE_TAG_songnodes_metadata_enrichment}}"
          services.seratoIntegration.image.repository: "{{.IMAGE_NAME_songnodes_serato_integration}}"
          services.seratoIntegration.image.tag: "{{.IMAGE_TAG_songnodes_serato_integration}}"
          services.frontend.image.repository: "{{.IMAGE_NAME_songnodes_frontend}}"
          services.frontend.image.tag: "{{.IMAGE_TAG_songnodes_frontend}}"
profiles:
  - name: dev-push
    build:
      local:
        push: true
    deploy:
      helm:
        releases:
          - name: songnodes
            namespace: songnodes
            createNamespace: true
            chartPath: deploy/helm/songnodes
            valuesFiles:
              - deploy/helm/songnodes/values-dev.yaml
            setValueTemplates:
              services.restApi.image.repository: "{{.IMAGE_NAME_songnodes_rest_api}}"
              services.restApi.image.tag: "{{.IMAGE_TAG_songnodes_rest_api}}"
              services.graphVisualization.image.repository: "{{.IMAGE_NAME_songnodes_graph_visualization_api}}"
              services.graphVisualization.image.tag: "{{.IMAGE_TAG_songnodes_graph_visualization_api}}"
              services.websocketApi.image.repository: "{{.IMAGE_NAME_songnodes_websocket_api}}"
              services.websocketApi.image.tag: "{{.IMAGE_TAG_songnodes_websocket_api}}"
              services.nlpProcessor.image.repository: "{{.IMAGE_NAME_songnodes_nlp_processor}}"
              services.nlpProcessor.image.tag: "{{.IMAGE_TAG_songnodes_nlp_processor}}"
              services.scraperOrchestrator.image.repository: "{{.IMAGE_NAME_songnodes_scraper_orchestrator}}"
              services.scraperOrchestrator.image.tag: "{{.IMAGE_TAG_songnodes_scraper_orchestrator}}"
              services.metadataEnrichment.image.repository: "{{.IMAGE_NAME_songnodes_metadata_enrichment}}"
              services.metadataEnrichment.image.tag: "{{.IMAGE_TAG_songnodes_metadata_enrichment}}"
              services.seratoIntegration.image.repository: "{{.IMAGE_NAME_songnodes_serato_integration}}"
              services.seratoIntegration.image.tag: "{{.IMAGE_TAG_songnodes_serato_integration}}"
              services.frontend.image.repository: "{{.IMAGE_NAME_songnodes_frontend}}"
              services.frontend.image.tag: "{{.IMAGE_TAG_songnodes_frontend}}"
  - name: flux
    build:
      local:
        push: true
    deploy:
      helm:
        releases:
          - name: songnodes
            namespace: songnodes
            createNamespace: false
            chartPath: deploy/helm/songnodes
            valuesFiles:
              - deploy/helm/songnodes/values.yaml
            setValues:
              namespace.create: false
              secrets.create: false
            setValueTemplates:
              services.restApi.image.repository: "{{.IMAGE_NAME_songnodes_rest_api}}"
              services.restApi.image.tag: "{{.IMAGE_TAG_songnodes_rest_api}}"
              services.graphVisualization.image.repository: "{{.IMAGE_NAME_songnodes_graph_visualization_api}}"
              services.graphVisualization.image.tag: "{{.IMAGE_TAG_songnodes_graph_visualization_api}}"
              services.websocketApi.image.repository: "{{.IMAGE_NAME_songnodes_websocket_api}}"
              services.websocketApi.image.tag: "{{.IMAGE_TAG_songnodes_websocket_api}}"
              services.nlpProcessor.image.repository: "{{.IMAGE_NAME_songnodes_nlp_processor}}"
              services.nlpProcessor.image.tag: "{{.IMAGE_TAG_songnodes_nlp_processor}}"
              services.scraperOrchestrator.image.repository: "{{.IMAGE_NAME_songnodes_scraper_orchestrator}}"
              services.scraperOrchestrator.image.tag: "{{.IMAGE_TAG_songnodes_scraper_orchestrator}}"
              services.metadataEnrichment.image.repository: "{{.IMAGE_NAME_songnodes_metadata_enrichment}}"
              services.metadataEnrichment.image.tag: "{{.IMAGE_TAG_songnodes_metadata_enrichment}}"
              services.seratoIntegration.image.repository: "{{.IMAGE_NAME_songnodes_serato_integration}}"
              services.seratoIntegration.image.tag: "{{.IMAGE_TAG_songnodes_serato_integration}}"
              services.frontend.image.repository: "{{.IMAGE_NAME_songnodes_frontend}}"
              services.frontend.image.tag: "{{.IMAGE_TAG_songnodes_frontend}}"
